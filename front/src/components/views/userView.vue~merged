<template>
  <div class="text-center">
    <v-btn
<<<<<<< HEAD
=======
      v-if="userRole === 'ADMIN'"
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
      depressed
      @click.stop="showCreateForm"
      bottom
      class="mb-8"
      color="deep-orange"
      dark
      fab
      fixed
      right
    >
      <v-icon>mdi-plus</v-icon>
    </v-btn>
    <v-dialog
      v-model="dialog"
      max-width="700"
      transition="dialog-top-transition"
    >
      <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|-CREATE FORM DIALOG-|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
      <v-card>
        <v-toolbar color="primary" class="lighten-1" dark>
          {{ dialogTitle }}
        </v-toolbar>
        <div v-if="dialogMode !== 'delete'">
          <v-card-text class="mt-5">
            <v-form ref="form" v-model="valid" lazy-validation>
              <v-text-field
                v-model="username"
                :rules="usernameRules"
                label="Username"
                prepend-icon="mdi-account"
                required
              ></v-text-field>

              <v-text-field
                v-model="email"
                :rules="emailRules"
                label="E-mail"
                prepend-icon="mdi-email"
                required
              ></v-text-field>
<<<<<<< HEAD
=======
              <v-alert dense outlined type="error" v-if="messageError !== ''">
                {{ messageError }}
              </v-alert>
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da

              <v-text-field
                v-if="dialogMode !== 'edit'"
                v-model="password"
                :rules="passwordRules"
                label="Password"
                prepend-icon="mdi-lock"
                :append-icon="show1 ? 'eye' : 'eye-off'"
                :type="show1 ? 'text' : 'password'"
                @click:append="show1 = !show1"
                required
              ></v-text-field>

              <v-select
                v-model="role"
                :items="roles"
                :rules="roleRules"
<<<<<<< HEAD
                prepend-icon="mdi-key"
=======
                prepend-icon="mdi-account-star"
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
                label="Select"
                required
              ></v-select>

<<<<<<< HEAD
              <!-- <v-file-input
                v-if="
                  role !== null && role === 'SOCIAL AFFAIL OFFICER' && dialogMode !== 'edit'
                "
                :rules="profileRules"
                v-model="profile"
                label="Choose image profile"
                filled
                prepend-icon="mdi-camera"
              ></v-file-input> -->

=======
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
              <v-combobox
                v-if="role === 'STUDENT'"
                :rules="studentRules"
                prepend-icon="mdi-account-multiple"
                label="Choose"
                v-model="student"
                :items="students"
<<<<<<< HEAD
              >
=======
                item-text="first_name"
                item-value="id"
              >
                <template v-slot:item="data">
                  <template>
                    <v-list-item-avatar>
                      <img :src="url + data.item.profile" />
                    </v-list-item-avatar>
                    <v-list-item-content>
                      <v-list-item-title
                        v-html="data.item.first_name"
                      ></v-list-item-title>
                      <v-list-item-subtitle
                        v-html="data.item.class"
                      ></v-list-item-subtitle>
                    </v-list-item-content>
                  </template>
                </template>
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
              </v-combobox>
            </v-form>
          </v-card-text>
        </div>

        <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|-REMOVE DIALOG-|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
        <div v-else>
          <v-card-text class="mt-5">
            <v-alert outlined type="error" prominent border="left">
              Are you sure to delete this user?
            </v-alert>
          </v-card-text>
        </div>

        <v-divider></v-divider>

        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn color="warning" @click="closeDialog"> close </v-btn>
          <v-btn :color="dialogColor" :disabled="!valid" @click="onConfirm">
            {{ dialogButton }}
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- TABLE -->

<<<<<<< HEAD
    <div class="container mt-12">
      <user-search
=======
    <div class="container">
      <v-alert
        type="success"
        class="mt-6"
        elevation="12"
        v-if="messageAlert !== ''"
        dismissible
        border="left"
        colored-border
      >
        {{ messageAlert }}
      </v-alert>
      <user-search
        class="mt-12"
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
        @searchByusername="searchUsername"
        @SelectRole="selectByRole"
      >
      </user-search>
<<<<<<< HEAD
      <v-simple-table>
        <template v-slot:default>
          <thead>
=======
      <v-simple-table class="mb-12">
        <template v-slot:default>
          <thead class="tableHead">
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
            <tr>
              <th>PROFILE</th>
              <th>USERNAME</th>
              <th>EMAIL</th>
              <th>ROLE</th>
<<<<<<< HEAD
              <th class="text-center">ACTION</th>
=======
              <th v-if="userRole === 'ADMIN'">ACTION</th>
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
            </tr>
          </thead>
          <tbody v-if="!isSearch">
            <user-card
              v-for="user of users"
              :key="user.id"
              :user="user"
              @requestToDeleteUser="showDeleteDialog"
              @requestToEdit="showEditForm"
            >
            </user-card>
          </tbody>
          <tbody v-else>
            <user-card
              v-for="user of contain_users_search"
              :key="user.id"
              :user="user"
              @requestToDeleteUser="showDeleteDialog"
              @requestToEdit="showEditForm"
            >
            </user-card>
          </tbody>
        </template>
      </v-simple-table>
    </div>
  </div>
</template>

<script>
<<<<<<< HEAD
// IMPORT AXIOS ----------------------------------------
import axios from "../../api/api.js";

// IMPORT USER FORM SEARCH ----------------------------------------
import UserFormSearch from "../pages/users/userFormSearch.vue";

// IMPORT USER CARD ----------------------------------------
=======
import axios from "../../api/api.js";
import UserFormSearch from "../pages/users/userFormSearch.vue";
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
import UserCard from "../pages/users/userCard.vue";
export default {
  components: {
    "user-search": UserFormSearch,
    "user-card": UserCard,
  },
<<<<<<< HEAD
  data() {
    return {
=======
  props: ["userdata"],
  data() {
    return {
      userRole: "",
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
      userId: null,
      valid: true,
      url: "http://localhost:8000/storage/images/",
      dialog: false,
      show1: false,
      dialogMode: "create",
      roles: ["SOCIAL AFFAIL OFFICER", "STUDENT"],
<<<<<<< HEAD
=======
      notStudentRole: ["STUDENT"],
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
      students: [],
      images: [
        "https://i.pinimg.com/236x/92/8f/c8/928fc874edae45b141ac45bdc157a70b.jpg",
        "https://i.pinimg.com/236x/c4/d3/e2/c4d3e2dd8797e6d7d5b07dbfc338d054.jpg",
        "https://i.pinimg.com/236x/3f/87/6c/3f876cc74af0f155af84306443b3ea56.jpg",
        "https://i.pinimg.com/236x/97/7f/e7/977fe798cf2c3a037e7aa9af6ce4b9d1.jpg",
      ],
      // DATA FROM INPUT ----------------------------------------
      username: null,
      email: null,
      password: null,
      student: null,
      role: null,
      profile: "",
      // RULE OF INPUT DATA ----------------------------------------
      usernameRules: [(v) => !!v || "Username is required"],
      emailRules: [
        (v) => !!v || "Email is required",
        (v) => /.+@.+\..+/.test(v) || "E-mail must be valid",
      ],
<<<<<<< HEAD
      passwordRules: [(v) => !!v || "Password is required"],
=======
      passwordRules: [
        (v) => !!v || "Password is required",
        (v) =>
          (v && v.length <= 8 && v.length >= 4) ||
          "Password must be at least 4 and less than 8 characters",
      ],
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
      studentRules: [(v) => !!v || "Student is required"],
      roleRules: [(v) => !!v || "Role is required"],
      profileRules: [(v) => !!v || "Profile is required"],
      // DATA GET FROM BACKEND ----------------------------------------
      users: [],
      userAction: {},
      dialogDisplay: false,
      isSearch: false,
      contain_users_search: [],
<<<<<<< HEAD
=======
      // MESSAGE DATA
      messageError: "",
      messageAlert: "",
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
    };
  },
  computed: {
    // **********************|~TITLE DIALOG~|********************** //
    dialogTitle() {
      let message = "";
      if (this.dialogMode === "create") {
        message = "CREATE NEW USER";
      } else if (this.dialogMode === "edit") {
        message = "EDIT THE USER";
      } else if (this.dialogMode === "delete") {
        message = "DELETE THE USER";
      }
      return message;
    },
    // **********************|~BUTTON DIALOG~|********************** //
    dialogButton() {
      let message = "";
      if (this.dialogMode === "create") {
        message = "CREATE";
      } else if (this.dialogMode === "edit") {
        message = "UPDATE";
      } else if (this.dialogMode === "delete") {
        message = "DELETE";
      }
      return message;
    },
    // **********************|~COLOR DIALOG~|********************** //
    dialogColor() {
      let message = "";
      if (this.dialogMode === "create") {
        message = "primary";
      } else if (this.dialogMode === "edit") {
        message = "success";
      } else if (this.dialogMode === "delete") {
        message = "error";
      }
      return message;
    },
  },
  methods: {
<<<<<<< HEAD
=======
    // **********************|~GET USER FROM BACKEND~|********************** //
    getUsers() {
      axios.get("/users").then((res) => {
        this.users = res.data;
      });
    },

>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
    // **********************|~SHOW CREATE FORM DIALOG~|********************** //
    showCreateForm() {
      this.dialogMode = "create";
      this.dialog = true;

      this.username = null;
      this.email = null;
      this.password = null;
      this.student = null;
      this.role = null;
      this.profile = "";
<<<<<<< HEAD
=======
      this.messageError = "";
      this.messageAlert = "";
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
    },
    // **********************|~SHOW REMOVE DIALOG~|********************** //
    showDeleteDialog(id) {
      this.userAction = {
        id: id,
      };
      this.dialogMode = "delete";
      this.dialog = true;
<<<<<<< HEAD
=======
      this.messageAlert = "";
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
    },
    // **********************|~CLOSE FORM DIALOG~|********************** //
    closeDialog() {
      this.dialog = false;
      if (this.dialogMode !== "delete") {
        this.$refs.form.reset();
      }
    },
    showEditForm(userData) {
      this.dialogMode = "edit";
      this.dialog = true;
      this.userAction = {
        id: userData.id,
        username: userData.username,
        email: userData.email,
        role: userData.roles,
<<<<<<< HEAD
=======
        student_id: userData.student_id,
        student: userData.student
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
      };
      this.username = this.userAction.username;
      this.email = this.userAction.email;
      if (userData.roles === "ADMIN") {
        this.role = "ADMIN";
<<<<<<< HEAD
      } else {
        this.role = this.userAction.role;
      }

    },
    updateUser() {
      if (this.userAction.role === "ADMIN") {
        this.role = "ADMIN";
      }
      let myNewUserData = {
        username: this.username,
        email: this.email,
        roles: this.role,
      };

      axios
        .put("/users/" + this.userAction.id, myNewUserData)
        .then((res) => {
          console.log(res.data);
          this.getUsers();
          this.closeDialog();
        })
        .catch((error) => {
          console.log(error.res.data.errors);
        });
=======
      } else if (userData.roles === "STUDENT") {
        this.role = this.userAction.role;
        if (userData.student_id !== null) {
          this.student = userData.student.first_name;
        }
      } else {
        this.role = this.userAction.role;
        this.student = null;
      }
      this.messageError = "";
      this.messageAlert = "";
      console.log(this.userAction)
    },
    updateUser() {
      let student_id = null;
      if (this.$refs.form.validate()) {
        if(this.role === "STUDENT") {
          if (this.student.id !== undefined) {
            student_id = this.student.id;
          } else {
            student_id = this.userAction.student_id
          }
        }

        if (this.userAction.role === "ADMIN") {
          this.role = "ADMIN";
        } 
        
        let myNewUserData = {
          username: this.username,
          email: this.email,
          roles: this.role,
          student_id: student_id
        };
    

        axios
          .put("/users/" + this.userAction.id, myNewUserData)
          .then((response) => {
            console.log(response.data);
            this.getUsers();
            this.closeDialog();
            this.messageAlert = "Update successfully!";
          })
          .catch((error) => {
            if (error.response.status === 500) {
              this.messageError =
                "The email has already been taken by other user!";
            }
        });
      }
      console.log(this.userAction)
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
    },

    // **********************|~CREATE NEW USER~|********************** //
    createUser() {
      if (this.$refs.form.validate()) {
<<<<<<< HEAD

        const imageRadom = Math.floor(Math.random() * this.images.length);
        this.profile = this.images[imageRadom];

=======
        const imageRadom = Math.floor(Math.random() * this.images.length);
        this.profile = this.images[imageRadom];

        let student_id = "";
        if (this.student !== null) {
          student_id = this.student.id;
        }

>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
        let userInfo = {
          username: this.username,
          email: this.email,
          password: this.password,
          password_confirmation: this.password,
          roles: this.role,
<<<<<<< HEAD
=======
          student_id: student_id,
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
          profile: this.profile,
        };
        axios
          .post("/register", userInfo)
          .then((response) => {
            this.users.push(response.data.user);
<<<<<<< HEAD
            localStorage.setItem("token", response.data.token);
            this.closeDialog();
          })
          .catch((error) => {
            console.log(error.response.data.errors);
=======
            this.closeDialog();
            this.messageAlert = "Create succussfully !";
          })
          .catch((error) => {
            this.messageError = error.response.data.errors.email[0];
            console.log(this.messageError);
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
          });
      }
    },

    // **********************|~REMOVE USER~|********************** //
    deleteUser() {
      let id = this.userAction.id;
      axios.delete("/users/" + id).then(() => {
        this.users = this.users.filter((user) => user.id !== id);
        this.closeDialog();
<<<<<<< HEAD
=======
        this.messageAlert = "Delete succussfully!";
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
      });
    },

    // **********************|~CONFIRM DIALOG~|********************** //
    onConfirm() {
      if (this.dialogMode === "create") {
        this.createUser();
      } else if (this.dialogMode === "delete") {
        this.deleteUser();
      } else if (this.dialogMode === "edit") {
        this.updateUser();
      }
    },

<<<<<<< HEAD
    // **********************|~GET USERS~|********************** //
    getUsers() {
      axios.get("/users").then((res) => {
        this.users = res.data;
      });
    },

=======
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
    //==========================SEARCH USER BY USERNAME============================================================
    // Search By Username-----------------------------------------------------------------------------
    searchUsername(username_key, role_key) {
      if (
        (username_key !== "" && role_key !== "ALL") ||
        (username_key === "" && role_key !== "ALL")
      ) {
        console.log(username_key);
        this.contain_users_search = this.users.filter(
          (user) =>
            user.username.toLowerCase().includes(username_key.toLowerCase()) &&
            user.roles.toLowerCase().includes(role_key.toLowerCase())
        );
      } else {
        this.contain_users_search = this.users.filter((user) =>
          user.username.toLowerCase().includes(username_key.toLowerCase())
        );
      }
      this.isSearch = true;
    },
    //Search By select roles---------------------------------------------------------------------------
    selectByRole(role_key) {
      if (role_key === "ALL") {
        this.getUsers();
        this.isSearch = false;
      } else {
        console.log(role_key);
        this.contain_users_search = this.users.filter((user) =>
          user.roles.toLowerCase().includes(role_key.toLowerCase())
        );
        this.isSearch = true;
      }
    },
  },
  mounted() {
    this.getUsers();
    this.userId = localStorage.getItem("userId");
<<<<<<< HEAD
  },
};
</script>
=======
    this.userRole = localStorage.getItem("role");

    axios
      .get("/students")
      .then((res) => {
        this.students = res.data;
      })
      .catch((error) => {
        console.log(error.res.data.errors);
      });
  },
};
</script>

<style scoped>
.text-center {
  background: url(https://cdn.pixabay.com/photo/2017/02/05/15/04/stones-2040340_960_720.jpg)
    fixed;
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  min-height: 100vh;
  max-height: auto;
}

.tableHead {
  background: #03a9f4;
}
</style>
>>>>>>> 2ba55be41eba78ea2facac7cf07c1b77b6a7a4da
